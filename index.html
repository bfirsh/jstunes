<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <title>jsTunes</title>
    
    <link type="text/css" href="css/jstunes.css" rel="Stylesheet">
    <link type="text/css" href="css/smoothness/jquery-ui-1.7.2.custom.css" rel="Stylesheet">
</head>

<body><div id="wrapper">
    <h1>jsTunes</h1>
    
        <p id="status">Loading...</p>
        <input type="file" id="file">
        
        <div id="player">
            <!--<canvas id="vis" width="1000" height="100"></canvas>-->
            <div id="position-slider" style="width:1000px; margin:15px;"></div>
        
            <p id="position">0:00</p>
            <p id="length">0:00</p>
        
            <input type="button" value="play" id="playpause" disabled="disabled">
            
            
            <div id="controls">
                <div id="volume">
                    <p class="ui-state-default ui-corner-all ui-helper-clearfix" style="padding:4px; margin-right: 10px">
                    <span class="ui-icon ui-icon-volume-on" style="float:left; margin:-2px 5px 0 0;"></span>
                    Volume
                    </p>

                    <div style="width:90%; margin:15px;"></div>
                </div>
            
                <div id="eq">
                    <p class="ui-state-default ui-corner-all" style="padding:4px">
                    <span class="ui-icon ui-icon-signal" style="float:left; margin:-2px 5px 0 0;"></span>
                    EQ <input type="checkbox" id="eq-enable">
                    </p>

                	<span id="bass"></span>
                	<span id="mid"></span>
                	<span id="treble"></span>
            	
                	<div id="freq" style="width: 90%; clear: left"></div>
                	<div id="width" style="width: 90%"></div>
                </div>
            </div>
            
        </div>

	<object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=10,0,0,0" width="1" height="1" id="jssound" align="middle">
	<param name="allowScriptAccess" value="sameDomain" />
	<param name="allowFullScreen" value="false" />
	<param name="movie" value="jssound.swf?callback=readJSSoundBuffer" /><param name="quality" value="high" /><param name="bgcolor" value="#ffffff" />	<embed src="jssound.swf?callback=readJSSoundBuffer" quality="high" bgcolor="#ffffff" width="1" height="1" name="jssound" align="middle" allowScriptAccess="always" allowFullScreen="false" type="application/x-shockwave-flash" pluginspage="http://www.adobe.com/go/getflashplayer" />
	</object>

</div>

<script src="js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript" src="js/jquery-ui-1.7.2.custom.min.js"></script>
<script src="js/buffer.js" type="text/javascript" charset="utf-8"></script>
<script src="js/eq.js" type="text/javascript" charset="utf-8"></script>
<script src="js/file.js" type="text/javascript" charset="utf-8"></script>
<script src="js/utils.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript" charset="utf-8">
    $(document).ready(function() {
        $('#status').text('Loaded.');
    });
    
    $.extend($.ui.slider.defaults, {
		range: "min",
		animate: true,
        max: 1000,
        value: 1000
	});
    
    var file;
    var eq;
    var sliding = false;
    
  	$('#player').show();
    $('#file').change(function() {
      
        $('#status').text('Loading '+$(this).val()+' ...');
        var fileStr = $(this).get(0).files[0].getAsBinary();
        var fileArray = new Array(fileStr.length);
        for (var i=0; i<fileStr.length; i++) {
            fileArray[i] = fileStr.charCodeAt(i);
        }
        file = new File(new Buffer(fileArray));
        
        eq = new EQ(44100);
        
        $('#status').text('Loaded.');
        
        $("#playpause").attr("disabled", null).attr("value", "play");
        
        // Set up position slider
        $('#length').text(formatTime(file.lengthSeconds));
        var slider = $("#position-slider").slider({
            value: 0,
            orientation: "horizontal"
        }).bind('slidechange', function(event, ui) {
      	    file.skipToSample(Math.floor(ui.value/1000 * file.lengthSamples));
      	}).bind('slidestart', function(event, ui) {
      	    sliding = true;
      	}).bind('slidestop', function(event, ui){
      	    sliding = false;
      	}).bind('slide', function(event, ui){
      	    $('#position').text(formatTime(ui.value/1000 * file.lengthSeconds));
      	});
      	
      	// Set up volume
		$("#volume div").slider({
			value: 1000,
			orientation: "horizontal"
		}).bind('slide', function(event, ui) {
		    // http://www.dr-lex.be/info-stuff/volumecontrols.html
		    file.volume = expVolume(ui.value/1000);
		});
		// Set up EQ
		$("#eq #bass").slider({
    		orientation: "vertical"
		}).bind('slide', function(event, ui) {
    		eq.bass = expVolume(ui.value/1000);
    	});
		$("#eq #mid").slider({
    		orientation: "vertical"
		}).bind('slide', function(event, ui) {
    		eq.mid = expVolume(ui.value/1000);
    	});
		$("#eq #treble").slider({
    		orientation: "vertical"
		}).bind('slide', function(event, ui) {
    		eq.treble = expVolume(ui.value/1000);
    	});
    	$("#eq #freq").slider({
    		orientation: "horizontal",
    		max: 5000,
    		min: 200,
    		value: 2000
		}).bind('slide', function(event, ui) {
    		eq.updateFreq(ui.value);
    	});
    	//setTimeout(function(){ generateVis(0); }, 0);
    });
    
    
    
    $("#playpause").click(function() {
        if ($(this).attr("value") == "play") {
            file.playing = true;
            $("#status").text("Playing");
            $(this).attr("value", "pause");
        }
        else {
            file.playing = false;
            $("#status").text("Paused");
            $(this).attr("value", "play");
        }
    });
    
    /*function generateVis(x) {
        var canvas = $('vis').get(0).getContext('2d');;
        var centre = context.canvas.height / 2;
        var length = 
        
        context.beginPath();
        context.lineWidth = 1;
        
        var oldPos = file.buffer.pos;
        
        
        context.moveTo
        
        if (x < context.canvas.width) {
            setTimeout(function(){ generateVis(x+1); }, 0);
        }
    }*/
    
    function readJSSoundBuffer() {
        if (file.playing) {
            var samples = JSON.stringify(file.readSamples(2048));
            if (!sliding) {
                $('#position').text(formatTime(file.positionSeconds));
                $('#position-slider').slider('option', 'value', Math.floor(file.positionSeconds/file.lengthSeconds * 1000));
            }
            return samples;
        }
        
    }
</script>
</body>
</html>
